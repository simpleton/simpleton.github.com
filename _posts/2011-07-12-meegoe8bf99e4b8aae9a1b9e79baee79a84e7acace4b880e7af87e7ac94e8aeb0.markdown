---
author: sunsj1231
comments: true
date: 2011-07-12 04:40:00
layout: post
slug: meego%e8%bf%99%e4%b8%aa%e9%a1%b9%e7%9b%ae%e7%9a%84%e7%ac%ac%e4%b8%80%e7%af%87%e7%ac%94%e8%ae%b0
title: '[meego]这个项目的第一篇笔记'
wordpress_id: 44033
---

来了有2周了，发现不会的东西太多了，但整天都在忙一些琐碎的事情，没办法集中精力去学习新知识。还有就是在地铁上得时间太多了，必须想想办法利用起来，不然太荒废了。每天3h啊。
好久没更新blog了。今天又otc的同事发的信，看果然不一样，写的很详细，也很清晰。一下解决了疑惑。后来发现这些其实在wiki上都有，囧自己一个，太挫了。

下面是几个以前搞得不太明白的小命令，以前fs都是rocket师兄搞，他超级熟悉，可以木有跟他好好学。现在搞起来有很多不懂的啊。下面是网络资源：

当使用虚拟机的时候，经常会遇到需要在不开虚拟机的情况下访问某个硬盘镜像的内容。对于KVM来说，基本上，最简单的方法是用mount -o loop命令装载镜像内容。但这个方法有其限制，如果镜像文件带有分区，就不行了。

当然，可以用mount -o loop,offset=的方式，指定一个偏移量，来解决这个问题。但是你必须事先知道分区开始的位置。

经过探索，终于发现使用losetup和kpartx可以解决这个难题。

下面先讲解一下losetup命令。如果你执行如下命令
代码:
ls /dev/loop?

可以看到/dev目录下有许多loop0、loop1等等的东西。这些是Linux的"loop设备"。当设定好之后，loop设备可以模仿磁盘设备，比如sda, hda那些，但实际上对该设备的访问被重定向到一个文件。要设定一个loop设备，要使用losetup命令。该命令需要用root权限运行

代码:
#关联loop文件到设备
losetup [loop设备] 文件名
#去除loop设备和文件的关联
losetup [loop设备] -d
#找下一个没有关联上文件的loop设备
losetup -f


当写脚本的时候，losetup -f特别有用，因为它会返回一个没有使用的loop设备，然后你就可以把该设备名保存在一个变量里面，供后续命令使用。

到现在为止，情况和mount -o loop并没有什么不同，尽管你立马可以mount上那个刚刚关联上文件的loop设备，但这等价于mount -o loop。但是，我们有kpartx。

如果你的系统还没有安装kpartx（默认是不装），先装上。

代码:
sudo apt-get install kpartx


kpartx命令的作用，是让Linux内核读取一个设备上的分区表，然后生成代表相应分区的设备。当然，它也需要root权限来运行。具体用法：

代码:
#列出设备上的分区和刷新后的设备名
kpartx [设备]
#刷新分区表和生成设备
kpartx [设备] -a
#删除指定设备上的所有分区设备
kpartx [设备] -d


对于loop设备，kpartx命令可以生成/dev/mapper/loop0p1这样格式的分区设备。

这样，有了kpartx命令，就可以用mount命令加载映像文件里面的各个分区了。
